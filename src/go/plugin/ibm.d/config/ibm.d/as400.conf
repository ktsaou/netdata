## netdata configuration for AS/400 (IBM i) monitoring
## https://github.com/netdata/netdata/tree/master/src/go/plugin/ibm.d/collector/as400#configuration

## This collector monitors IBM AS/400 (IBM i) systems via IBM DB2 connection.
## It requires the ibm.d.plugin (not the regular go.d.plugin) because it needs
## CGO and IBM DB2 client libraries.

## Prerequisites:
## 1. IBM DB2 client libraries must be installed
## 2. IBM_DB_HOME environment variable must be set
## 3. LD_LIBRARY_PATH must include DB2 library path
## 4. Database user must have SELECT permissions on QSYS2 schema tables

#------------------------------------------------------------------------------
# JOBS (data collection sources)

## Each job represents a connection to an AS/400 system.
## You can define multiple jobs to monitor multiple AS/400 systems.

jobs:
  ## Example: Basic AS/400 connection
  ## Uncomment and modify the following example:
  
  # - name: as400_production
  #   # Data Source Name (DSN) for IBM DB2 connection
  #   # Required: yes
  #   dsn: 'DATABASE=;HOSTNAME=your.as400.host;PORT=446;PROTOCOL=TCPIP;UID=username;PWD=password'
  #   # IMPORTANT: For production environments, consider using secure methods for credential management
  #   # instead of storing them directly in this file (e.g., environment variables, secrets management systems).
  #   # Ensure DB2 connections are secured with SSL/TLS.
  #   
  #   # Update interval in seconds
  #   # Default: 5
  #   update_every: 5
  #   
  #   # Connection timeout
  #   # Default: 2
  #   timeout: 2
  #   
  #   # Maximum database connections
  #   # Default: 1
  #   max_db_conns: 1
  #   
  #   # Maximum database connection lifetime
  #   # Default: 10m
  #   max_db_conn_lifetime: 10m

  ## Example: SSL connection (IBM Cloud)
  # - name: as400_cloud
  #   dsn: 'DATABASE=bludb;HOSTNAME=your-host.databases.appdomain.cloud;PORT=32211;PROTOCOL=TCPIP;UID=your-uid;PWD=your-pwd;SECURITY=SSL;SSLServerCertificate=/path/to/cert.crt'
  #   timeout: 5

  ## Example: Large system with cardinality control
  ## Use this configuration for systems with many disks, subsystems, or job queues
  ## to prevent excessive memory usage and chart creation
  
  # - name: as400_large_system
  #   dsn: 'DATABASE=;HOSTNAME=large.as400.com;PORT=446;PROTOCOL=TCPIP;UID=monitor;PWD=secret'
  #   
  #   # Per-instance metric collection settings
  #   # These control which detailed metrics are collected
  #   
  #   # Collect disk metrics (per-disk statistics)
  #   # Default: true
  #   collect_disk_metrics: true
  #   
  #   # Maximum number of disks to monitor
  #   # Default: 50 (0 = unlimited)
  #   max_disks: 20
  #   
  #   # Pattern to filter disks. Supports wildcards (*, ?) and multiple patterns separated by |
  #   # Example: '*SSD*' to monitor only SSD disks, 'DD*|DM*' for DD or DM disks
  #   # Default: '' (all disks)
  #   collect_disks_matching: ''
  #   
  #   # Collect subsystem metrics (per-subsystem statistics)
  #   # Default: true
  #   collect_subsystem_metrics: true
  #   
  #   # Maximum number of subsystems to monitor
  #   # Default: 50 (0 = unlimited)
  #   max_subsystems: 10
  #   
  #   # Pattern to filter subsystems. Supports wildcards (*, ?) and multiple patterns separated by |
  #   # Example: 'QINTER' for interactive subsystem only, 'Q*' for all Q subsystems
  #   # Default: '' (all subsystems)
  #   collect_subsystems_matching: ''
  #   
  #   # Collect job queue metrics (per-queue statistics)
  #   # Default: true
  #   collect_job_queue_metrics: true
  #   
  #   # Maximum number of job queues to monitor
  #   # Default: 50 (0 = unlimited)
  #   max_job_queues: 20
  #   
  #   # Pattern to filter job queues. Supports wildcards (*, ?) and multiple patterns separated by |
  #   # Example: 'QBATCH*' for batch queues only, '*PROD*|*TEST*' for prod or test queues
  #   # Default: '' (all queues)
  #   collect_job_queues_matching: ''
  #   
  #   # Collect metrics for top active jobs by CPU usage
  #   # Default: false
  #   collect_active_jobs: false
  #   
  #   # Maximum number of active jobs to monitor
  #   # Default: 10
  #   max_active_jobs: 10
  #
  #   # Monitor top N IFS directories by size
  #   # Default: 20 (0 = disabled)
  #   ifs_top_n_directories: 20
  #   
  #   # Starting path for IFS directory monitoring
  #   # Default: '/' (root directory)
  #   ifs_start_path: '/'
  #   
  #   # Virtual node (vnode) assignment
  #   # Associates this job with a Virtual Node in Netdata Cloud
  #   # Default: not set
  #   # vnode: 'as400-prod'

  ## Example: Minimal monitoring (system-wide metrics only)
  ## Use this for basic monitoring without per-instance details
  
  # - name: as400_minimal
  #   dsn: 'DATABASE=;HOSTNAME=minimal.as400.com;PORT=446;PROTOCOL=TCPIP;UID=monitor;PWD=secret'
  #   # Disable all per-instance metrics
  #   collect_disk_metrics: false
  #   collect_subsystem_metrics: false
  #   collect_job_queue_metrics: false

  ## Example: Filtered collection
  ## Monitor specific resources using SQL LIKE patterns
  
  # - name: as400_filtered
  #   dsn: 'DATABASE=;HOSTNAME=filtered.as400.com;PORT=446;PROTOCOL=TCPIP;UID=monitor;PWD=secret'
  #   # Monitor only SSD disks
  #   collect_disks_matching: '*SSD*'
  #   max_disks: 0  # No limit since we're filtering
  #   
  #   # Monitor only interactive and batch subsystems
  #   collect_subsystems_matching: 'Q*'
  #   
  #   # Monitor only batch job queues
  #   collect_job_queues_matching: 'QBATCH*'

#------------------------------------------------------------------------------
# COLLECTED METRICS

## System-wide metrics (always collected):
## - CPU utilization (overall, partition, interactive, database, shared pool)
## - CPU configuration (configured CPUs, current processing capacity)
## - Active jobs count and job type breakdown (batch, interactive, system, spooled, other)
## - System ASP (Auxiliary Storage Pool) usage
## - Memory pool usage (Machine, Base, Interactive, Spool)
## - Memory pool sizes (current, defined, reserved for Machine and Base pools)
## - IFS (Integrated File System) usage and file count
## - System message queue depths (QSYSMSG, QSYSOPR)
## - Critical message counts in system queues
## - Aggregate disk busy percentage
## - Aggregate job queue length

## Per-disk metrics (when collect_disk_metrics is true):
## - Disk busy percentage
## - I/O requests per second (read/write)
## - I/O throughput (read/write bytes/s)
## - Average response time

## Per-subsystem metrics (when collect_subsystem_metrics is true):
## - Active jobs count
## - Jobs on job queues
## - Jobs held on job queues
## - Storage used (MB)

## Per-job-queue metrics (when collect_job_queue_metrics is true):
## - Jobs waiting
## - Jobs held
## - Jobs scheduled

## Per-job metrics (when collect_active_jobs is true):
## - CPU time used
## - Temporary storage used
## - Job active time
## - Elapsed CPU percentage

#------------------------------------------------------------------------------
# TROUBLESHOOTING

## 1. "error loading shared libraries: libdb2.so"
##    - Ensure LD_LIBRARY_PATH includes DB2 client library path
##    - For systemd services, add to the service file:
##      Environment="LD_LIBRARY_PATH=/path/to/db2/lib"

## 2. "SQL1042C An unexpected system error occurred"
##    - Check DB2 client version compatibility
##    - Verify SSL certificate path and permissions

## 3. "cgo: C compiler not found"
##    - Install gcc or build-essential package
##    - The ibm.d.plugin requires CGO

## 4. Certificate errors with SSL connections
##    - Use absolute paths for SSLServerCertificate
##    - Ensure certificate is in PEM format
##    - Check file permissions (readable by netdata user)

## 5. Permission denied errors
##    - Grant SELECT permissions on QSYS2 tables:
##      GRANT SELECT ON QSYS2.SYSTEM_STATUS_INFO TO monitor_user;
##      GRANT SELECT ON QSYS2.ASP_INFO TO monitor_user;
##      GRANT SELECT ON QSYS2.MEMORY_POOL_INFO TO monitor_user;
##      (see documentation for complete list)

#------------------------------------------------------------------------------
# TESTING YOUR CONFIGURATION

## To test this collector, run as netdata user:
## cd /usr/libexec/netdata/plugins.d/
## sudo -u netdata -s
## export IBM_DB_HOME=/path/to/db2/client
## export LD_LIBRARY_PATH=$IBM_DB_HOME/lib:$LD_LIBRARY_PATH
## ./ibm.d.plugin -d -m as400