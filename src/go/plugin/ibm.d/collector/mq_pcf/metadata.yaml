plugin_name: ibm.d.plugin
modules:
  - meta:
      module_name: mq_pcf
      monitored_instance:
        name: IBM MQ (PCF)
        link: https://www.ibm.com/products/mq
        categories:
          - messaging
          - enterprise
        icon_filename: "ibm_mq.svg"
    overview:
      data_collection:
        metrics_description: |
          Collects comprehensive metrics for IBM MQ queue managers, queues, channels, and topics using the Programmable Command Format (PCF) interface. Provides detailed monitoring of message flow, resource utilization, and system performance.
        method_description: |
          Uses IBM MQ PCF (Programmable Command Format) commands to query queue manager statistics, queue depths, channel status, and topic activity. Requires IBM MQ client libraries and appropriate authentication.
      supported_platforms:
        include:
          - Linux
        exclude: []
      multi_instance: true
      additional_permissions:
        description: "Requires IBM MQ connect permissions and inquiry access to monitored objects."
    setup:
      prerequisites:
        list:
          - title: IBM MQ Client Libraries
            description: |
              IBM MQ client libraries version 8.0+ must be installed. The collector requires:
              - libmqm.so (MQ runtime library)
              - MQ header files for PCF commands
              - Proper LD_LIBRARY_PATH configuration
          - title: MQ Permissions
            description: |
              The monitoring user must have:
              - CONNECT authority to the queue manager
              - INQUIRE authority on queues, channels, and topics to be monitored  
              - DISPLAY authority for PCF commands
          - title: Server Connection Channel
            description: |
              A server connection channel must be defined and running on the queue manager to accept client connections.
      configuration:
        file:
          name: ibm.d/mq_pcf.conf
        options:
          description: |
            The following options can be defined for this collector.
          folding:
            title: Config options
            enabled: true
          list:
            - name: update_every
              description: Data collection frequency in seconds.
              default_value: 5
              required: false
            - name: queue_manager
              description: Name of the IBM MQ queue manager to monitor.
              default_value: ""
              required: true
            - name: channel
              description: Server connection channel name.
              default_value: "SYSTEM.DEF.SVRCONN"
              required: false
            - name: host
              description: Hostname or IP address of the queue manager.
              default_value: "localhost"
              required: false
            - name: port
              description: Port number of the queue manager listener.
              default_value: 1414
              required: false
            - name: user
              description: Username for authentication (optional).
              default_value: ""
              required: false
            - name: password
              description: Password for authentication (optional).
              default_value: ""
              required: false
            - name: collect_queues
              description: Enable collection of queue statistics.
              default_value: true
              required: false
            - name: collect_channels
              description: Enable collection of channel statistics.
              default_value: true
              required: false
            - name: collect_topics
              description: Enable collection of topic statistics.
              default_value: false
              required: false
            - name: queue_selector
              description: Regular expression to filter monitored queues.
              default_value: ""
              required: false
            - name: channel_selector
              description: Regular expression to filter monitored channels.
              default_value: ""
              required: false
        examples:
          folding:
            enabled: true
            title: Config examples
          list:
            - name: Local queue manager
              description: Monitor a local queue manager with default settings.
              config: |
                jobs:
                  - name: local_qm
                    queue_manager: 'QM1'
                    host: 'localhost'
                    port: 1414
                    collect_queues: true
                    collect_channels: true
            - name: Remote queue manager with authentication
              description: Monitor a remote queue manager with user authentication.
              config: |
                jobs:
                  - name: production_qm
                    queue_manager: 'PROD.QM'
                    channel: 'NETDATA.SVRCONN'
                    host: 'mqserver.example.com'
                    port: 1414
                    user: 'netdata'
                    password: 'monitoring_password'
                    collect_queues: true
                    collect_channels: true
                    collect_topics: true
            - name: Filtered monitoring
              description: Monitor only application queues and specific channels.
              config: |
                jobs:
                  - name: app_monitoring
                    queue_manager: 'APP.QM'
                    host: 'localhost'
                    port: 1414
                    queue_selector: '^APP\.'
                    channel_selector: '^TO\.'
                    collect_queues: true
                    collect_channels: true
    troubleshooting:
      problems:
        list:
          - name: Cannot connect to queue manager
            description: |
              - Verify queue manager is running: `dspmq`
              - Check if listener is active: `runmqsc QM1` then `DIS LISTENER(*)`
              - Verify server connection channel exists and is running
              - Check firewall settings for MQ port (default 1414)
              - Ensure MQ client libraries are properly installed
          - name: Permission denied errors
            description: |
              - Verify user has CONNECT authority: `setmqaut -m QM1 -t qmgr -p <user> +connect`
              - Grant INQUIRE authority on objects: `setmqaut -m QM1 -t queue -n '**' -p <user> +inq`
              - Check channel security: `runmqsc QM1` then `DIS CHL(<channel>)`
          - name: High CPU usage
            description: |
              - Disable topic collection if not needed (`collect_topics: false`)
              - Increase update_every interval to reduce polling frequency
              - Use selectors to limit monitored objects
              - Consider monitoring only critical queues and channels
    metrics:
      folding:
        title: Metrics
        enabled: false
      description: "Comprehensive metrics for IBM MQ infrastructure monitoring. All charts include version labels (mq_version, mq_edition) for filtering by MQ version and edition."
      availability: []
      scopes:
        - name: queue manager
          description: "Metrics for the IBM MQ queue manager instance."
          labels:
            - name: mq_version
              description: "IBM MQ version"
            - name: mq_edition
              description: "IBM MQ edition (Advanced, Standard, Express)"
          metrics:
            - name: mq_pcf.qmgr_status
              description: Queue Manager Status
              unit: "status"
              chart_type: line
              dimensions:
                - name: status
            - name: mq_pcf.qmgr_cpu_usage
              description: Queue Manager CPU Usage
              unit: "percentage"
              chart_type: line
              dimensions:
                - name: cpu_usage
            - name: mq_pcf.qmgr_memory_usage
              description: Queue Manager Memory Usage
              unit: "bytes"
              chart_type: line
              dimensions:
                - name: memory_usage
            - name: mq_pcf.qmgr_log_usage
              description: Queue Manager Log Usage
              unit: "percentage"
              chart_type: line
              dimensions:
                - name: log_usage
        - name: queue
          description: "Metrics for individual MQ queues."
          labels:
            - name: queue
              description: "Queue name"
            - name: mq_version
              description: "IBM MQ version"
            - name: mq_edition
              description: "IBM MQ edition (Advanced, Standard, Express)"
          metrics:
            - name: mq_pcf.queue_depth
              description: Queue Current Depth
              unit: "messages"
              chart_type: line
              dimensions:
                - name: depth
            - name: mq_pcf.queue_messages
              description: Queue Message Rate
              unit: "messages/s"
              chart_type: line
              dimensions:
                - name: enqueued
                - name: dequeued
            - name: mq_pcf.queue_oldest_message_age
              description: Queue Oldest Message Age
              unit: "seconds"
              chart_type: line
              dimensions:
                - name: age
        - name: channel
          description: "Metrics for individual MQ channels."
          labels:
            - name: channel
              description: "Channel name"
            - name: mq_version
              description: "IBM MQ version"
            - name: mq_edition
              description: "IBM MQ edition (Advanced, Standard, Express)"
          metrics:
            - name: mq_pcf.channel_status
              description: Channel Status
              unit: "status"
              chart_type: line
              dimensions:
                - name: status
            - name: mq_pcf.channel_messages
              description: Channel Message Rate
              unit: "messages/s"
              chart_type: line
              dimensions:
                - name: messages
            - name: mq_pcf.channel_bytes
              description: Channel Data Transfer Rate
              unit: "bytes/s"
              chart_type: line
              dimensions:
                - name: bytes
            - name: mq_pcf.channel_batches
              description: Channel Batch Rate
              unit: "batches/s"
              chart_type: line
              dimensions:
                - name: batches
        - name: topic
          description: "Metrics for individual MQ topics (when enabled)."
          labels:
            - name: topic
              description: "Topic name"
            - name: mq_version
              description: "IBM MQ version"
            - name: mq_edition
              description: "IBM MQ edition (Advanced, Standard, Express)"
          metrics:
            - name: mq_pcf.topic_publishers
              description: Topic Publishers
              unit: "publishers"
              chart_type: line
              dimensions:
                - name: publishers
            - name: mq_pcf.topic_subscribers
              description: Topic Subscribers
              unit: "subscribers"
              chart_type: line
              dimensions:
                - name: subscribers
            - name: mq_pcf.topic_messages
              description: Topic Message Rate
              unit: "messages/s"
              chart_type: line
              dimensions:
                - name: messages